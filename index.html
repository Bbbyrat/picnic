<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ¶ä½œå±äºä½ çš„ä¸‹åˆèŒ¶ï¼</title>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  padding: 0;
  text-align: center;
  font-family: "ZCOOL KuaiLe", cursive;
  background-color: #ffffff;
  background-image:
    linear-gradient(45deg,#fff2bd 25%,transparent 25%,transparent 75%,#fff0b4 75%,#fff1bb),
    linear-gradient(45deg,#fff1b8 25%,transparent 25%,transparent 75%,#ffefad 75%,#ffec9f);
  background-size: 160px 160px;
  background-position: 0 0, 80px 80px;
}

h1 { font-size: 30px; color: #d9568f; margin: 16px 0 8px; }
p { font-size: 14px; color: #d2496b; margin: 0 0 12px; }

#camera-container {
  position: relative;
  width: 320px;
  height: 240px;
  margin: auto;
  z-index: 1;
}

#video {
  width: 320px;
  height: 240px;
  border-radius: 12px;
  border: 4px solid #ff8aaf;
  box-shadow: 0 10px 20px rgba(255,195,29,0.2);
  transform: scaleX(-1);
  object-fit: cover;  /* è§†é¢‘å¡«æ»¡æ•´ä¸ªæ–¹æ¡† */
}

#overlay { position: absolute; top: 0; left: 0; }

.decor-row {
  display: flex;
  gap: 24px;
  justify-content: center;
  margin: 12px 0;
}

.decor {
  font-size: 48px;
  animation: swing 3s ease-in-out infinite;
  opacity: 0.85;
}

#decor-top .decor:nth-child(1) { animation-delay: 0s; }
#decor-top .decor:nth-child(2) { animation-delay: 0.2s; }
#decor-top .decor:nth-child(3) { animation-delay: 0.4s; }
#decor-top .decor:nth-child(4) { animation-delay: 0.6s; }
#decor-top .decor:nth-child(5) { animation-delay: 0.8s; }

#decor-bottom .decor:nth-child(1) { animation-delay: 1s; }
#decor-bottom .decor:nth-child(2) { animation-delay: 1.2s; }
#decor-bottom .decor:nth-child(3) { animation-delay: 1.4s; }
#decor-bottom .decor:nth-child(4) { animation-delay: 1.6s; }
#decor-bottom .decor:nth-child(5) { animation-delay: 1.8s; }

@keyframes swing {
  0% { transform: rotate(-6deg); }
  50% { transform: rotate(6deg); }
  100% { transform: rotate(-6deg); }
}

#analyzeBtn {
  margin-top: 12px;
  padding: 10px 18px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: #ffc9d4;
  color: #d2496b;
  cursor: pointer;
  z-index: 2;
}

#result {
  margin-top: 12px;
  width: 320px;
  margin-left: auto;
  margin-right: auto;
  background: #ffc9d4;
  padding: 10px;
  text-align: left;
  white-space: pre-wrap;
  color: #d9568f;
  z-index: 2;
}
</style>
</head>

<body>

<h1>ä½ æ‹¥æœ‰äº†ä¸€å—é‡é¤åœ°æ¯¯</h1>
<p>æŒ‰ç…§æˆ‘ä»¬ä¸ºä½ å®šåˆ¶çš„é£Ÿè°±å¼€å§‹äº«ç”¨å§</p>

<!-- ä¸Šæ’è£…é¥° -->
<div class="decor-row" id="decor-top">
  <div class="decor">ğŸª</div>
  <div class="decor">ğŸ</div>
  <div class="decor">ğŸ¥›</div>
  <div class="decor">ğŸ®</div>
  <div class="decor">ğŸ«</div>
</div>

<div id="camera-container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="overlay" width="320" height="240"></canvas>
</div>

<!-- ä¸‹æ’è£…é¥° -->
<div class="decor-row" id="decor-bottom">
  <div class="decor">ğŸ§¸</div>
  <div class="decor">ğŸ‰</div>
  <div class="decor">ğŸ</div>
  <div class="decor">â˜•</div>
  <div class="decor">ğŸŒ¸</div>
</div>

<button id="analyzeBtn">å¼€å§‹åˆ†æ</button>
<div id="result">ç­‰å¾…æ¨¡å‹åŠ è½½...</div>

<script src="./face-api.min.js"></script>
<script>
const video = document.getElementById("video");
const result = document.getElementById("result");
const analyzeBtn = document.getElementById("analyzeBtn");

let modelsLoaded = false;

async function loadModels() {
  result.innerText = "æ­£åœ¨åŠ è½½æƒ…ç»ªè¯†åˆ«æ¨¡å‹...";
  await faceapi.nets.tinyFaceDetector.loadFromUri("./models");
  await faceapi.nets.faceExpressionNet.loadFromUri("./models");
  modelsLoaded = true;
  result.innerText = "æ¨¡å‹åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»å¼€å§‹åˆ†æ";
}
loadModels();

analyzeBtn.onclick = async () => {
  if (!modelsLoaded) {
    alert("æ¨¡å‹è¿˜æ²¡åŠ è½½å®Œæˆï¼Œè¯·ç¨ç­‰");
    return;
  }

  if (!video.srcObject) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
    } catch {
      alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–æµè§ˆå™¨æ”¯æŒ");
      return;
    }
  }

  const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
  if (!detection) {
    result.innerText = "æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·æ­£å¯¹æ‘„åƒå¤´";
    return;
  }
  const mood = mapExpressionsToTenLevels(detection.expressions);
  showRecipe(mood);
};

function mapExpressionsToTenLevels(expr) {
  const score = expr.happy - expr.sad;
  if (score <= -0.8) return "æåº¦ä½è½";
  if (score <= -0.6) return "å¾ˆä½è½";
  if (score <= -0.4) return "ä½è½";
  if (score <= -0.2) return "ç•¥ä½è½";
  if (score <= 0) return "ä¸­æ€§åä½";
  if (score <= 0.2) return "ä¸­æ€§åé«˜";
  if (score <= 0.4) return "ç•¥å¼€å¿ƒ";
  if (score <= 0.6) return "å¼€å¿ƒ";
  if (score <= 0.8) return "å¾ˆå¼€å¿ƒ";
  return "éå¸¸å¼€å¿ƒ";
}

function showRecipe(mood) {
  const recipes = {
    "æåº¦ä½è½": "ç™½åå¸ + æ›²å¥‡ + å°‘é‡ç‚¼ä¹³ + æœå†» + ç”Ÿæ—¥å¸½ + å°ç†Š",
    "å¾ˆä½è½": "ç™½åå¸ + ç‚¼ä¹³ + æœå†» + å°ç†Š + å·§å…‹åŠ›",
    "ä½è½": "ç™½åå¸ + è‹æ‰“é¥¼å¹² + æœå†» + å°ç†Š",
    "ç•¥ä½è½": "ç™½åå¸ + æ²™æ‹‰é…± + æœå†» + å°‘é‡å·§å…‹åŠ›",
    "ä¸­æ€§åä½": "ç™½åå¸ + æœå†» + å°‘é‡ç‚¼ä¹³ + å°ç†Š",
    "ä¸­æ€§åé«˜": "ç™½åå¸ + æ›²å¥‡ + ç‚¼ä¹³ + å°ç†Š",
    "ç•¥å¼€å¿ƒ": "æ›²å¥‡ + ç™½åå¸ + ç‚¼ä¹³ + è½¯ç³–",
    "å¼€å¿ƒ": "æ›²å¥‡ + ç™½åå¸ + ç‚¼ä¹³ + è½¯ç³– + å°ç†Š",
    "å¾ˆå¼€å¿ƒ": "æ›²å¥‡ + å·§å…‹åŠ› + ç‚¼ä¹³ + è½¯ç³– + å°ç†Š",
    "éå¸¸å¼€å¿ƒ": "æ›²å¥‡ + å·§å…‹åŠ› + ç‚¼ä¹³ + è½¯ç³– + å°ç†Š + ç”Ÿæ—¥å¸½"
  };
  result.innerText = `æ£€æµ‹åˆ°æƒ…ç»ªçŠ¶æ€ï¼š${mood}\n\næ¨èè¿›é£Ÿæ–¹æ¡ˆï¼š\n${recipes[mood]}`;
}
</script>
</body>
</html>
